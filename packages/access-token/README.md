# Twilio access token
Client apps need [access tokens](https://www.twilio.com/docs/conversations/create-tokens) to authenticate and connect to the Conversations service as a user. These tokens should be generated by this app.

## Getting started

What you'll need to get started:

- A [Twilio Account SID](#twilio-account-sid)
- Chat [Service SID](#chat-service-sid)
- A Firebase project to [set up push notifications](#setting-up-push-notifications).
- API crendentials to a [commercetools instance](https://docs.commercetools.com/getting-started/create-api-client)

### Twilio Account SID
This is the Account SID of your Twilio account and must be the account in which you have created your Conversations Chat Service. 
- Create API keys from [twilio account](https://www.twilio.com/console/project/api-keys) and store it in `TWILIO_API_KEY` and `TWILIO_API_SECRET` variable in  file.
- Fetch live credentials account SID and Auth token from [twilio account](https://www.twilio.com/console/project/api-keys) and store them in  `TWILIO_ACCOUNT_SID` and `TWILIO_AUTH_TOKEN` variables in .env file.
- Setup push notifications in Firebase and store the SID in `PUSH_CREDENTIAL_SID` in the .env file.

### Chat Service SID
This SID is the unique identifier for a Chat Service instance, where your Participants, Conversations, Messages and other Conversations-related data reside. This is the Chat Service you grant the SDK client access to.
- Open (Conversations Services)[https://www.twilio.com/console/conversations/services]
- Copy the SID for Default Conversations Service, or the service you want to set up to `TWILIO_CHAT_SERVICE_SID` in the .env file

## Setting up Push Notifications

This app uses Firebase for processing notifications.
### Set up Firebase

1. Create a [Firebase project](https://firebase.google.com)
2. Go to the [Project Settings](https://console.firebase.google.com/project/_/settings/general/)
3. Got to the **Cloud Messaging** and enable **Cloud Messaging API (Legacy)** through the "kebab" menu besides it.
4. Note or copy the Server Key token for creating push credentials. 

### Create Push Credential

Create a push credential to add a push grant to our access token. 
1. Go to the [Credentials](twilio.com/console/project/credentials/push-credentials) section of the console.
2. Create a new FCM Push Credential and set the Firebase Cloud Message Server Key Token as the `FCM Secret`.
3. Note or copy the `CREDENTIAL SID` to set as `PUSH_CREDENTIAL_SID` env variable. 

### Create Firebase App set config

From the Firebase [Project Settings](https://console.firebase.google.com/project/_/settings/general/) **General** tab, add a web app to get the `firebaseConfig`, it should look like this:

```javascript
var firebaseConfig = {
  apiKey: "sample__key12345678901234567890",
  authDomain: "convo-demo-app-internal.firebaseapp.com",
  projectId: "convo-demo-app-internal",
  storageBucket: "convo-demo-app-internal.appspot.com",
  messagingSenderId: "1234567890",
  appId: "1:1234567890:web:1234abcd",
  measurementId: "EXAMPLE_ID"
};
```

### Enable Push Notification in Conversations Service

Select your [conversations service](https://www.twilio.com/console/conversations/services), navigate to the **Push Notifications** section, and check the **Push notifications enabled** boxes for the push notifications you want. 

## GCP
The `gcp-build` NPM script is used to trigger the TypeScript compilation
process. This step happens automatically when deploying to App Engine, but must
be performed manually when developing locally.

## Setup

Install dependencies:

   npm install

## Deploying
`gcloud functions logs read twilio-access-token-generator`
`gcloud functions deploy twilio-access-token-generator --runtime nodejs18 --trigger-http --allow-unauthenticated --build-env-vars-file .env.yaml --entry-point twilioAccessTokenGenerator`